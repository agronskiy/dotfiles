#!/usr/bin/env bash
# Read input preserving all bytes including ANSI codes
# Read all input into a variable without creating a temporary file
tmpfile=$(mktemp)
exec 3> "$tmpfile"  # write
exec 4< "$tmpfile"  # read
exec 5< "$tmpfile"  # read x2
rm "$tmpfile"


# Strip ANSI escape sequences for clipboard (remove color codes)
# Remove all ANSI escape sequences:
# - CSI sequences: \x1b[ followed by parameters and a command letter
# - OSC sequences: \x1b] followed by parameters and BEL or ST
# - Other escape sequences: \x1b followed by various characters
cat >&3
printf "\033]52;c;%s\a" "$(cat <&4 | sed -E 's/\x1b\[[0-9;]*[a-zA-Z]//g; s/\x1b\][^[:cntrl:]]*(\x07|\x1b\\)//g; s/\x1b[()\[][0-9;]*//g' | base64 -w0)"

# Output original input with colors preserved
cat <&5
